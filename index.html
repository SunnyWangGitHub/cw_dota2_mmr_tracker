<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dota2 MMR Tracker</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #1c1e21; color: #e4e6eb; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 24px; color: #fff; }
    
    .container { max-width: 1000px; margin: 0 auto; background: #242526; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    
    /* æ®µä½å±•ç¤ºåŒºåŸŸ */
    .rank-display {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #3a3b3c;
      border-radius: 8px;
      border: 1px solid #4e4f50;
    }
    .rank-title { font-size: 14px; color: #b0b3b8; margin-bottom: 5px; }
    .rank-name { font-size: 28px; font-weight: bold; background: linear-gradient(45deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .rank-mmr { font-size: 18px; color: #fff; margin-top: 5px; }

    .input-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #3e4042; }
    input, button { padding: 10px 15px; font-size: 16px; border: 1px solid #3e4042; border-radius: 6px; outline: none; background: #18191a; color: white; }
    input:focus { border-color: #2e7d32; }
    button { background: #2e7d32; color: white; border: none; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    button:hover { background: #1b5e20; }
    button:disabled { background: #555; cursor: not-allowed; }
    
    #chart { width: 100%; height: 600px; } /* å¢åŠ é«˜åº¦ä»¥å®¹çº³ä¸¤ä¸ªå›¾è¡¨ */
    .loading { text-align: center; color: #b0b3b8; display: none; }
  </style>
</head>

<body>

<div class="container">
  <h1>âš”ï¸ Dota2 MMR Tracker</h1>

  <!-- æ–°å¢ï¼šæ®µä½å±•ç¤º -->
  <div class="rank-display">
    <div class="rank-title">å½“å‰æ®µä½ (Season 4)</div>
    <div class="rank-name" id="current-rank">æš‚æ— æ•°æ®</div>
    <div class="rank-mmr" id="current-mmr">--</div>
  </div>

  <div class="input-group">
    <input type="date" id="date-picker">
    <input type="number" id="mmr-input" placeholder="è¾“å…¥å½“å‰ MMR">
    <button id="save-btn">ğŸ’¾ è®°å½•æˆ˜ç»©</button>
  </div>
  
  <p id="loading-text" class="loading">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</p>
  <div id="chart"></div>
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // âš ï¸âš ï¸âš ï¸ è¯·åœ¨æ­¤å¤„æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Firebase é…ç½® âš ï¸âš ï¸âš ï¸
  const firebaseConfig = {
    apiKey: "AIzaSyCSAb-Cgpn3IYzytnV5twT4QmdDMHz6-kU",
    authDomain: "cw-dota2-mmr-tracker.firebaseapp.com",
    projectId: "cw-dota2-mmr-tracker",
    storageBucket: "cw-dota2-mmr-tracker.firebasestorage.app",
    messagingSenderId: "682798543046",
    appId: "1:682798543046:web:d8380bb8122d109b67e7c7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const mmrCol = collection(db, "mmrHistory");
  
  document.getElementById("date-picker").valueAsDate = new Date();

  // --- æ ¸å¿ƒé€»è¾‘ 1: æ®µä½è®¡ç®— ---
  function calculateMedal(mmr) {
    if (mmr < 770) return { name: "Herald (å…ˆé”‹)", stars: getStars(mmr, 0) };
    if (mmr < 1540) return { name: "Guardian (å«å£«)", stars: getStars(mmr, 770) };
    if (mmr < 2310) return { name: "Crusader (ä¸­å†›)", stars: getStars(mmr, 1540) };
    if (mmr < 3080) return { name: "Archon (ç»Ÿå¸…)", stars: getStars(mmr, 2310) };
    if (mmr < 3850) return { name: "Legend (ä¼ å¥‡)", stars: getStars(mmr, 3080) };
    if (mmr < 4620) return { name: "Ancient (ä¸‡å¤)", stars: getStars(mmr, 3850) };
    return { name: "Divine (è¶…å‡¡)", stars: getStars(mmr, 4620) }; // 5420+ æ˜¯å† ç»ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
  }

  function getStars(mmr, base) {
    // æ¯é¢—æ˜Ÿå¤§çº¦ 154 åˆ† (770 / 5)
    const diff = mmr - base;
    const starCount = Math.floor(diff / 154) + 1;
    return starCount > 5 ? 5 : (starCount < 1 ? 1 : starCount);
  }

  function updateRankDisplay(mmr) {
    const medal = calculateMedal(mmr);
    const starStr = "â˜…".repeat(medal.stars);
    document.getElementById("current-rank").innerText = `${medal.name} ${starStr}`;
    document.getElementById("current-mmr").innerText = `${mmr} MMR`;
  }

  // --- ä¿å­˜é€»è¾‘ ---
  const saveBtn = document.getElementById("save-btn");
  saveBtn.addEventListener("click", async () => {
    const date = document.getElementById("date-picker").value;
    const mmrValue = parseInt(document.getElementById("mmr-input").value);

    if (!date || isNaN(mmrValue)) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œ MMR åˆ†æ•°");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "ä¿å­˜ä¸­...";

    try {
      await setDoc(doc(mmrCol, `${date}_${Date.now()}`), { 
        date: date, 
        mmr: mmrValue,
        timestamp: Date.now()
      });
      document.getElementById("mmr-input").value = "";
    } catch (err) {
      console.error("å†™å…¥å¤±è´¥:", err);
      alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Rules");
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "ğŸ’¾ è®°å½•æˆ˜ç»©";
    }
  });

  // --- æ•°æ®å¤„ç†ä¸ç»˜å›¾ ---
  let myChart = null;
  document.getElementById("loading-text").style.display = "block";
  
  // æŒ‰æ—¶é—´æˆ³æ’åºæŸ¥è¯¢ï¼Œè¿™å¯¹è®¡ç®—èƒœè´Ÿè‡³å…³é‡è¦
  const q = query(mmrCol); 

  onSnapshot(q, (snapshot) => {
    document.getElementById("loading-text").style.display = "none";
    
    // 1. æå–æ‰€æœ‰åŸå§‹è®°å½•å¹¶æŒ‰æ—¶é—´æ’åº
    let rawRecords = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if(data.date && data.mmr) {
        // å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ timestamp å­—æ®µï¼Œç”¨ date è¡¥å…¨ä¸€ä¸ª
        const ts = data.timestamp || new Date(data.date).getTime();
        rawRecords.push({ ...data, timestamp: ts });
      }
    });
    
    // ç¡®ä¿ç»å¯¹çš„æ—¶é—´é¡ºåº
    rawRecords.sort((a, b) => a.timestamp - b.timestamp);

    if (rawRecords.length === 0) return;

    // æ›´æ–°æœ€æ–°æ®µä½
    updateRankDisplay(rawRecords[rawRecords.length - 1].mmr);

    // 2. æ•°æ®èšåˆ
    const map = new Map(); // å­˜ MMR æ•°ç»„
    const winLossMap = new Map(); // å­˜ {wins: 0, losses: 0}

    let prevMMR = null;

    rawRecords.forEach(record => {
      const d = record.date;
      
      // æ”¶é›† MMR ç”¨äºç®±çº¿å›¾
      if (!map.has(d)) map.set(d, []);
      map.get(d).push(record.mmr);

      // è®¡ç®—èƒœè´Ÿ (å¯¹æ¯”ä¸Šä¸€æ¡è®°å½•)
      if (!winLossMap.has(d)) winLossMap.set(d, { wins: 0, losses: 0 });
      
      if (prevMMR !== null) {
        if (record.mmr > prevMMR) {
          winLossMap.get(d).wins += 1;
        } else if (record.mmr < prevMMR) {
          winLossMap.get(d).losses += 1;
        }
      }
      prevMMR = record.mmr;
    });

    drawChart(map, winLossMap);
  });

  function calcBox(arr) {
    arr.sort((a, b) => a - b);
    const q1 = arr[Math.floor((arr.length - 1) * 0.25)];
    const mid = arr[Math.floor((arr.length - 1) * 0.5)];
    const q3 = arr[Math.floor((arr.length - 1) * 0.75)];
    return [arr[0], q1, mid, q3, arr[arr.length - 1]];
  }

  function drawChart(mmrMap, wlMap) {
    const dates = [...mmrMap.keys()].sort();
    
    const boxData = [];
    const avgLine = [];
    const winsData = [];
    const lossesData = [];

    dates.forEach(d => {
      // ç®±çº¿å›¾æ•°æ®
      const arr = mmrMap.get(d);
      boxData.push(calcBox(arr));
      avgLine.push(Math.round(arr.reduce((a,b) => a + b, 0) / arr.length));

      // èƒœè´Ÿæ•°æ®
      const wl = wlMap.get(d);
      winsData.push(wl.wins);
      lossesData.push(wl.losses); // è´Ÿåœºæ˜¾ç¤ºä¸ºæ­£æ•°ï¼Œå †å 
    });

    const option = {
      backgroundColor: '#242526', // æ·±è‰²èƒŒæ™¯
      title: {
        text: 'MMR è¶‹åŠ¿ & æ¯æ—¥æˆ˜å†µ',
        left: 'center',
        textStyle: { color: '#fff' }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'cross' },
        backgroundColor: 'rgba(50,50,50,0.9)',
        borderColor: '#777',
        textStyle: { color: '#fff' }
      },
      axisPointer: { link: { xAxisIndex: 'all' } }, // ä¸¤ä¸ªå›¾è¡¨åæ ‡è½´è”åŠ¨
      legend: { 
        top: 30, 
        data: ['ç®±çº¿å›¾', 'å¹³å‡MMR', 'èƒœ', 'è´Ÿ'],
        textStyle: { color: '#ccc' }
      },
      grid: [
        { left: '5%', right: '5%', height: '55%', top: '15%' }, // ä¸Šæ–¹å›¾è¡¨ (MMR)
        { left: '5%', right: '5%', top: '78%', height: '15%' }  // ä¸‹æ–¹å›¾è¡¨ (èƒœè´Ÿ)
      ],
      xAxis: [
        {
          type: 'category',
          data: dates,
          gridIndex: 0,
          axisLabel: { show: false }, // ä¸Šæ–¹å›¾è¡¨éšè—Xè½´æ–‡å­—
          axisLine: { lineStyle: { color: '#555' } }
        },
        {
          type: 'category',
          data: dates,
          gridIndex: 1,
          axisLabel: { color: '#999', rotate: 45 },
          axisLine: { lineStyle: { color: '#555' } }
        }
      ],
      yAxis: [
        {
          type: 'value',
          name: 'MMR',
          scale: true,
          gridIndex: 0,
          splitLine: { lineStyle: { color: '#333' } },
          axisLabel: { color: '#ccc' },
          nameTextStyle: { color: '#ccc' }
        },
        {
          type: 'value',
          name: 'åœºæ¬¡',
          gridIndex: 1,
          splitLine: { show: false },
          axisLabel: { color: '#ccc', interval: 0 }, // å¼ºåˆ¶æ˜¾ç¤ºæ•´æ•°
          minInterval: 1,
          nameTextStyle: { color: '#ccc' }
        }
      ],
      series: [
        {
          name: 'ç®±çº¿å›¾',
          type: 'boxplot',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: boxData,
          itemStyle: { color: '#00bcd4', borderColor: '#008ba3' }
        },
        {
          name: 'å¹³å‡MMR',
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: avgLine,
          smooth: true,
          lineStyle: { width: 3, color: '#ffeb3b' },
          symbol: 'none'
        },
        {
          name: 'èƒœ',
          type: 'bar',
          stack: 'total', // å †å 
          xAxisIndex: 1,
          yAxisIndex: 1,
          data: winsData,
          itemStyle: { color: '#4caf50' } // ç»¿è‰²ä»£è¡¨èƒœ
        },
        {
          name: 'è´Ÿ',
          type: 'bar',
          stack: 'total', // å †å 
          xAxisIndex: 1,
          yAxisIndex: 1,
          data: lossesData,
          itemStyle: { color: '#f44336' } // çº¢è‰²ä»£è¡¨è´Ÿ
        }
      ]
    };

    if (!myChart) {
      myChart = echarts.init(document.getElementById("chart"));
      window.addEventListener("resize", () => myChart.resize());
    }
    myChart.setOption(option);
  }
</script>

</body>
</html>
