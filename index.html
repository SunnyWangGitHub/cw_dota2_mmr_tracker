<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dota2 MMR è¶‹åŠ¿è®°å½•</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 24px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .input-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    input, button { padding: 10px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
    input:focus { border-color: #4caf50; }
    button { background: #2e7d32; color: white; border: none; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    button:hover { background: #1b5e20; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #chart { width: 100%; height: 500px; }
    .loading { text-align: center; color: #666; display: none; }
  </style>
</head>

<body>

<div class="container">
  <h1>ğŸ“Š Dota2 MMR çˆ¬å‘ä¹‹è·¯</h1>

  <div class="input-group">
    <input type="date" id="date-picker">
    <input type="number" id="mmr-input" placeholder="è¾“å…¥å½“å‰ MMR">
    <button id="save-btn">ğŸ’¾ è®°å½•ä¸€ä¸‹</button>
  </div>
  
  <p id="loading-text" class="loading">æ­£åœ¨åŒæ­¥æ•°æ®...</p>
  <div id="chart"></div>
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"; // ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // é…ç½®
  const firebaseConfig = {
    apiKey: "AIzaSyCSAb-Cgpn3IYzytnV5twT4QmdDMHz6-kU",
    authDomain: "cw-dota2-mmr-tracker.firebaseapp.com",
    projectId: "cw-dota2-mmr-tracker",
    storageBucket: "cw-dota2-mmr-tracker.firebasestorage.app",
    messagingSenderId: "682798543046",
    appId: "1:682798543046:web:d8380bb8122d109b67e7c7"
  };


  // åˆå§‹åŒ–
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const mmrCol = collection(db, "mmrHistory");
  
  // 1. è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  document.getElementById("date-picker").valueAsDate = new Date();

  // 2. ä¿å­˜é€»è¾‘
  const saveBtn = document.getElementById("save-btn");
  saveBtn.addEventListener("click", async () => {
    const date = document.getElementById("date-picker").value;
    const mmrValue = parseInt(document.getElementById("mmr-input").value);

    if (!date || isNaN(mmrValue)) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œ MMR åˆ†æ•°");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "ä¿å­˜ä¸­...";

    try {
      // ä½¿ç”¨ date_æ—¶é—´æˆ³ ä½œä¸ºIDï¼Œé˜²æ­¢åŒä¸€å¤©å¤šæ¬¡è®°å½•è¦†ç›–é—®é¢˜ï¼ˆå¦‚æœä½ æƒ³åŒä¸€å¤©å¤šæ¬¡è®°å½•ï¼‰
      // å¦‚æœä½ æƒ³åŒä¸€å¤©åªä¿ç•™æœ€åä¸€æ¬¡ï¼Œå¯ä»¥ç”¨ doc(mmrCol, date)
      await setDoc(doc(mmrCol, `${date}_${Date.now()}`), { 
        date: date, 
        mmr: mmrValue,
        timestamp: Date.now() // åŠ ä¸Šæ—¶é—´æˆ³æ–¹ä¾¿æ’åº
      });
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById("mmr-input").value = "";
      console.log("ä¿å­˜æˆåŠŸ");
    } catch (err) {
      console.error("å†™å…¥å¤±è´¥:", err);
      alert("ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥ Firebase æ§åˆ¶å°çš„ Rules æ˜¯å¦å·²è®¾ç½®ä¸º allow write: if true");
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "ğŸ’¾ è®°å½•ä¸€ä¸‹";
    }
  });

  // 3. å…¨å±€ Chart å®ä¾‹ï¼Œé˜²æ­¢é‡å¤ init
  let myChart = null;

  // 4. ç›‘å¬æ•°æ®å˜åŒ–
  document.getElementById("loading-text").style.display = "block";
  
  // è¿™é‡Œçš„æŸ¥è¯¢é€»è¾‘ï¼šè™½ç„¶æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯åšèšåˆï¼Œä½†æœ€å¥½è¿˜æ˜¯æŒ‰æŸç§é¡ºåºæ‹‰å–
  const q = query(mmrCol); 

  onSnapshot(q, (snapshot) => {
    document.getElementById("loading-text").style.display = "none";
    
    const map = new Map();
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      // å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ date å­—æ®µè·³è¿‡
      if(data.date && data.mmr) {
        if (!map.has(data.date)) map.set(data.date, []);
        map.get(data.date).push(data.mmr);
      }
    });

    if (map.size === 0) {
        // è¿˜æ²¡æœ‰æ•°æ®çš„æƒ…å†µ
        return;
    }
    drawChart(map);
  }, (error) => {
    console.error("è¯»å–æ•°æ®å¤±è´¥:", error);
    alert("è¯»å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Rules æƒé™ã€‚");
  });

  // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—ç®±çº¿å›¾çš„ [min, Q1, median, Q3, max]
  function calcBox(arr) {
    arr.sort((a, b) => a - b);
    const q1 = arr[Math.floor((arr.length - 1) * 0.25)];
    const mid = arr[Math.floor((arr.length - 1) * 0.5)];
    const q3 = arr[Math.floor((arr.length - 1) * 0.75)];
    return [arr[0], q1, mid, q3, arr[arr.length - 1]];
  }

  function drawChart(map) {
    // ç¡®ä¿æ—¥æœŸæ’åº
    const dates = [...map.keys()].sort();
    const boxData = [];
    const avgLine = [];

    dates.forEach(d => {
      const arr = map.get(d);
      boxData.push(calcBox(arr));
      // è®¡ç®—å¹³å‡å€¼ä¿ç•™æ•´æ•°
      const avg = Math.round(arr.reduce((a,b) => a + b, 0) / arr.length);
      avgLine.push(avg);
    });

    // å“åº”å¼é…ç½®
    const w = window.innerWidth;
    const isMobile = w < 600;

    const option = {
      title: {
        text: 'MMR æ¯æ—¥åˆ†å¸ƒä¸å‡åˆ†è¶‹åŠ¿',
        left: 'center',
        textStyle: { fontSize: isMobile ? 16 : 20 }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: function (param) {
            // è‡ªå®šä¹‰ tooltip è®©ä»–æ›´æ˜“è¯»
            let result = `<strong>${param[0].name}</strong><br/>`;
            param.forEach(p => {
                if(p.seriesName === 'å¹³å‡MMR') {
                    result += `å¹³å‡åˆ†: ${p.value}<br/>`;
                } else if (p.seriesName === 'ç®±çº¿å›¾') {
                    result += `æœ€é«˜: ${p.value[5]}<br/>`;
                    result += `æœ€ä½: ${p.value[1]}<br/>`;
                    result += `ä¸­ä½: ${p.value[3]}<br/>`;
                }
            });
            return result;
        }
      },
      legend: { top: 30, data: ['ç®±çº¿å›¾', 'å¹³å‡MMR'] },
      grid: { left: '3%', right: '4%', bottom: '3%', top: 80, containLabel: true },
      xAxis: {
        type: 'category',
        data: dates,
        boundaryGap: true,
        axisLabel: { rotate: 45 }
      },
      yAxis: {
        type: 'value',
        name: 'MMR',
        scale: true, // è®©Yè½´ä¸ä»0å¼€å§‹ï¼Œè¿™æ ·æ›´èƒ½çœ‹å‡ºåˆ†æ•°çš„æ³¢åŠ¨
        splitArea: { show: true }
      },
      series: [
        {
          name: 'ç®±çº¿å›¾',
          type: 'boxplot',
          data: boxData,
          itemStyle: { color: '#e0f2f1', borderColor: '#00695c' }
        },
        {
          name: 'å¹³å‡MMR',
          type: 'line',
          data: avgLine,
          smooth: true,
          symbolSize: 8,
          lineStyle: { width: 3, color: '#ff9800' },
          itemStyle: { color: '#ff9800' }
        }
      ]
    };

    // å…³é”®ä¿®å¤ï¼šåªåˆå§‹åŒ–ä¸€æ¬¡
    if (!myChart) {
      myChart = echarts.init(document.getElementById("chart"));
      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      window.addEventListener("resize", () => myChart.resize());
    }
    myChart.setOption(option);
  }
</script>

</body>
</html>
