<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dota2 MMR Tracker</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #1c1e21; color: #e4e6eb; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 24px; color: #fff; }

    .container { max-width: 1000px; margin: 0 auto; background: #242526; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

    /* æ®µä½å±•ç¤ºåŒºåŸŸ */
    .rank-display {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #3a3b3c;
      border-radius: 8px;
      border: 1px solid #4e4f50;
    }
    .rank-title { font-size: 14px; color: #b0b3b8; margin-bottom: 5px; }
    .rank-name { font-size: 28px; font-weight: bold; background: linear-gradient(45deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .rank-mmr { font-size: 18px; color: #fff; margin-top: 5px; }

    /* æ–°å¢ï¼šç›®æ ‡è®¡ç®—å™¨æ ·å¼ */
    .goal-calculator {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #4e4f50;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
    }
    .goal-item {
      background: #242526;
      padding: 10px 15px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
      border: 1px solid #4e4f50;
    }
    .goal-name { font-size: 14px; color: #b0b3b8; margin-bottom: 5px; }
    .goal-diff { font-size: 16px; font-weight: bold; color: #4caf50; }
    .goal-games { font-size: 12px; color: #999; margin-top: 4px; }
    .goal-games span { color: #fff; font-weight: bold; }
    .goal-done { color: #4caf50; font-weight: bold; }

    .input-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #3e4042; }
    input, button { padding: 10px 15px; font-size: 16px; border: 1px solid #3e4042; border-radius: 6px; outline: none; background: #18191a; color: white; }
    input:focus { border-color: #2e7d32; }
    button { background: #2e7d32; color: white; border: none; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    button:hover { background: #1b5e20; }
    button:disabled { background: #555; cursor: not-allowed; }

    #chart { width: 100%; height: 600px; }
    .loading { text-align: center; color: #b0b3b8; display: none; }
  </style>
</head>

<body>

<div class="container">
  <h1>âš”ï¸ Dota2 MMR Tracker</h1>

  <!-- æ®µä½å±•ç¤º -->
  <div class="rank-display">
    <div class="rank-title">å½“å‰æ®µä½ (Season 4)</div>
    <div class="rank-name" id="current-rank">æš‚æ— æ•°æ®</div>
    <div class="rank-mmr" id="current-mmr">--</div>

    <!-- æ–°å¢ï¼šç›®æ ‡è®¡ç®—å™¨ -->
    <div class="goal-calculator" id="goal-calc">
      <!-- è¿™é‡Œçš„å†…å®¹ä¼šç”± JS åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <div class="input-group">
    <input type="date" id="date-picker">
    <input type="number" id="mmr-input" placeholder="è¾“å…¥å½“å‰ MMR">
    <button id="save-btn">ğŸ’¾ è®°å½•æˆ˜ç»©</button>
  </div>

  <p id="loading-text" class="loading">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</p>
  <div id="chart"></div>
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    query
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCSAb-Cgpn3IYzytnV5twT4QmdDMHz6-kU",
    authDomain: "cw-dota2-mmr-tracker.firebaseapp.com",
    projectId: "cw-dota2-mmr-tracker",
    storageBucket: "cw-dota2-mmr-tracker.firebasestorage.app",
    messagingSenderId: "682798543046",
    appId: "1:682798543046:web:d8380bb8122d109b67e7c7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const mmrCol = collection(db, "mmrHistory");

  document.getElementById("date-picker").valueAsDate = new Date();

  // --- æ ¸å¿ƒé€»è¾‘ 1: æ®µä½è®¡ç®— ---
  function calculateMedal(mmr) {
    if (mmr < 770) return { name: "Herald (å…ˆé”‹)", stars: getStars(mmr, 0) };
    if (mmr < 1540) return { name: "Guardian (å«å£«)", stars: getStars(mmr, 770) };
    if (mmr < 2310) return { name: "Crusader (ä¸­å†›)", stars: getStars(mmr, 1540) };
    if (mmr < 3080) return { name: "Archon (ç»Ÿå¸…)", stars: getStars(mmr, 2310) };
    if (mmr < 3850) return { name: "Legend (ä¼ å¥‡)", stars: getStars(mmr, 3080) };
    if (mmr < 4620) return { name: "Ancient (ä¸‡å¤)", stars: getStars(mmr, 3850) };
    return { name: "Divine (è¶…å‡¡)", stars: getStars(mmr, 4620) };
  }

  function getStars(mmr, base) {
    const diff = mmr - base;
    const starCount = Math.floor(diff / 154) + 1;
    return starCount > 5 ? 5 : (starCount < 1 ? 1 : starCount);
  }

  // --- æ–°å¢ï¼šæ›´æ–°ç›®æ ‡è®¡ç®—å™¨ ---
  function updateGoals(currentMMR) {
    const goals = [
      { name: "Archon (ç»Ÿå¸…)", target: 2310 },
      { name: "Legend (ä¼ å¥‡)", target: 3080 }
    ];

    const container = document.getElementById("goal-calc");
    container.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹

    goals.forEach(goal => {
      const diff = goal.target - currentMMR;
      const div = document.createElement("div");
      div.className = "goal-item";

      if (diff <= 0) {
        div.innerHTML = `
          <div class="goal-name">ç›®æ ‡ï¼š${goal.name}</div>
          <div class="goal-done">âœ… å·²è¾¾æˆ</div>
        `;
      } else {
        const normalGames = Math.ceil(diff / 25);
        const doubleGames = Math.ceil(diff / 50);
        div.innerHTML = `
          <div class="goal-name">è·ç¦» ${goal.name}</div>
          <div class="goal-diff">è¿˜å·® ${diff} åˆ†</div>
          <div class="goal-games">æ™®é€š(+25): <span>${normalGames}</span> åœº</div>
          <div class="goal-games">åŒå€(+50): <span>${doubleGames}</span> åœº</div>
        `;
      }
      container.appendChild(div);
    });
  }

  function updateRankDisplay(mmr) {
    const medal = calculateMedal(mmr);
    const starStr = "â˜…".repeat(medal.stars);
    document.getElementById("current-rank").innerText = `${medal.name} ${starStr}`;
    document.getElementById("current-mmr").innerText = `${mmr} MMR`;
    
    // åŒæ—¶æ›´æ–°ç›®æ ‡
    updateGoals(mmr);
  }

  // --- ä¿å­˜é€»è¾‘ ---
  const saveBtn = document.getElementById("save-btn");
  saveBtn.addEventListener("click", async () => {
    const date = document.getElementById("date-picker").value;
    const mmrValue = parseInt(document.getElementById("mmr-input").value);

    if (!date || isNaN(mmrValue)) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œ MMR åˆ†æ•°");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "ä¿å­˜ä¸­...";

    try {
      await setDoc(doc(mmrCol, `${date}_${Date.now()}`), {
        date: date,
        mmr: mmrValue,
        timestamp: Date.now()
      });
      document.getElementById("mmr-input").value = "";
    } catch (err) {
      console.error("å†™å…¥å¤±è´¥:", err);
      alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Rules");
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "ğŸ’¾ è®°å½•æˆ˜ç»©";
    }
  });

  // --- æ•°æ®å¤„ç†ä¸ç»˜å›¾ ---
  let myChart = null;
  document.getElementById("loading-text").style.display = "block";

  const q = query(mmrCol);

  onSnapshot(q, (snapshot) => {
    document.getElementById("loading-text").style.display = "none";

    let rawRecords = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if(data.date && data.mmr) {
        const dateTs = new Date(data.date).getTime();
        const writeTs = data.timestamp || dateTs;

        rawRecords.push({
          ...data,
          sortKey: dateTs,
          secondarySortKey: writeTs
        });
      }
    });

    if (rawRecords.length === 0) return;

    // ä¸¥æ ¼æ’åº
    rawRecords.sort((a, b) => {
      if (a.sortKey !== b.sortKey) {
        return a.sortKey - b.sortKey;
      }
      return a.secondarySortKey - b.secondarySortKey;
    });

    // æ›´æ–°æœ€æ–°æ®µä½å’Œç›®æ ‡
    const latestRecord = rawRecords[rawRecords.length - 1];
    updateRankDisplay(latestRecord.mmr);

    // --- å›¾è¡¨æ•°æ®èšåˆ ---
    const map = new Map();
    const winLossMap = new Map();
    let prevMMR = null;

    rawRecords.forEach(record => {
      const d = record.date;

      if (!map.has(d)) map.set(d, []);
      map.get(d).push(record.mmr);

      if (!winLossMap.has(d)) winLossMap.set(d, { wins: 0, losses: 0 });

      if (prevMMR !== null) {
        if (record.mmr > prevMMR) {
          winLossMap.get(d).wins += 1;
        } else if (record.mmr < prevMMR) {
          winLossMap.get(d).losses += 1;
        }
      }
      prevMMR = record.mmr;
    });

    drawChart(map, winLossMap);
  });

  function calcBox(arr) {
    arr.sort((a, b) => a - b);
    const q1 = arr[Math.floor((arr.length - 1) * 0.25)];
    const mid = arr[Math.floor((arr.length - 1) * 0.5)];
    const q3 = arr[Math.floor((arr.length - 1) * 0.75)];
    return [arr[0], q1, mid, q3, arr[arr.length - 1]];
  }

  function drawChart(mmrMap, wlMap) {
    const dates = [...mmrMap.keys()].sort();

    const boxData = [];
    const avgLine = [];
    const winsData = [];
    const lossesData = [];

    dates.forEach(d => {
      const arr = mmrMap.get(d);
      boxData.push(calcBox(arr));
      avgLine.push(Math.round(arr.reduce((a,b) => a + b, 0) / arr.length));

      const wl = wlMap.get(d);
      winsData.push(wl.wins);
      lossesData.push(wl.losses);
    });

    const option = {
      backgroundColor: '#242526',
      title: {
        text: 'MMR è¶‹åŠ¿ & æ¯æ—¥æˆ˜å†µ',
        left: 'center',
        textStyle: { color: '#fff' }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'cross' },
        backgroundColor: 'rgba(50,50,50,0.9)',
        borderColor: '#777',
        textStyle: { color: '#fff' }
      },
      axisPointer: { link: { xAxisIndex: 'all' } },
      legend: {
        top: 30,
        data: ['ç®±çº¿å›¾', 'å¹³å‡MMR', 'èƒœ', 'è´Ÿ'],
        textStyle: { color: '#ccc' }
      },
      grid: [
        { left: '5%', right: '5%', height: '55%', top: '15%' },
        { left: '5%', right: '5%', top: '78%', height: '15%' }
      ],
      xAxis: [
        {
          type: 'category',
          data: dates,
          gridIndex: 0,
          axisLabel: { show: false },
          axisLine: { lineStyle: { color: '#555' } }
        },
        {
          type: 'category',
          data: dates,
          gridIndex: 1,
          axisLabel: { color: '#999', rotate: 45 },
          axisLine: { lineStyle: { color: '#555' } }
        }
      ],
      yAxis: [
        {
          type: 'value',
          name: 'MMR',
          scale: true,
          gridIndex: 0,
          splitLine: { lineStyle: { color: '#333' } },
          axisLabel: { color: '#ccc' },
          nameTextStyle: { color: '#ccc' }
        },
        {
          type: 'value',
          name: 'åœºæ¬¡',
          gridIndex: 1,
          splitLine: { show: false },
          axisLabel: { color: '#ccc', interval: 0 },
          minInterval: 1,
          nameTextStyle: { color: '#ccc' }
        }
      ],
      series: [
        {
          name: 'ç®±çº¿å›¾',
          type: 'boxplot',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: boxData,
          itemStyle: { color: '#00bcd4', borderColor: '#008ba3' }
        },
        {
          name: 'å¹³å‡MMR',
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: avgLine,
          smooth: true,
          lineStyle: { width: 3, color: '#ffeb3b' },
          symbol: 'none'
        },
        {
          name: 'èƒœ',
          type: 'bar',
          stack: 'total',
          xAxisIndex: 1,
          yAxisIndex: 1,
          data: winsData,
          itemStyle: { color: '#4caf50' }
        },
        {
          name: 'è´Ÿ',
          type: 'bar',
          stack: 'total',
          xAxisIndex: 1,
          yAxisIndex: 1,
          data: lossesData,
          itemStyle: { color: '#f44336' }
        }
      ]
    };

    if (!myChart) {
      myChart = echarts.init(document.getElementById("chart"));
      window.addEventListener("resize", () => myChart.resize());
    }
    myChart.setOption(option);
  }
</script>

</body>
</html>



